<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>R8-O7 Crowd Interaction Astromech: Software Design</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="R5Example.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">R8-O7 Crowd Interaction Astromech<span id="projectnumber">&#160;807</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('page_Software.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Software Design </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >R8-07’s software was designed as a main-brain style Real Time Operating System program. This means that a majority of data during normal operation is fed into a single task where it is interpreted and distilled. That “main-brain” task then makes decisions based on the information garnered from the various sensor tasks and commands the operator tasks. This layout is illustrated in the task diagram shown in FIGURE. Here, the main brain is the <a class="el" href="classNavigation.html" title="A class containing functions for driving a dual-motor robot within a geofence.">Navigation</a> Task which takes information from the Sensor Suite Task and the Geofence Task to determine the appropriate PWM signal to send to the motor driver task. <br  />
 </p><div class="image">
<img src="TaskDiagram.png" alt=""/>
<div class="caption">
Task Diagram for R8-07's governing program</div></div>
<h1><a class="anchor" id="section_Geofence"></a>
Geofence Algorithm</h1>
<p >To ensure the robot remains within the prescribed area, an appropriate algorithm was developed to determine the distance and bearing of the closest edge (or point) of the geofence. While many basic geofence algorithms use the polygon method to constrain the robot, we determined that a simple inside/outside geofence return was insufficient for our goals of relatively natural movement. While the polygon method operates on the principle of intersection of lines in the geofence (if a horizontal line emitted to one side of the robot has an odd number of intersects, it is in the polygon geofence), our algorithm operates off of a geometric computation using the closest point on the geofence along with the two adjacent points. <br  />
</p>
<div class="image">
<img src="GeofenceTriangles.png" alt=""/>
<div class="caption">
Geometric Setup of Geofencing Algorithm</div></div>
<p >As seen in the figure above, the robot’s location and the location of the aforementioned three points is sufficient to determine geometrically if there is a perpendicular distance to either of the geofence lines, which is necessarily the closest distance to the robot. The bearing to the fence is also returned as an angle relative to the horizontal +x axis as defined by the coordinate frame of the GPS readings. <br  />
 <br  />
 To determine the closest point, at this point we use a simplistic “halving” algorithm. This sorting algorithm enters the data set at the median value of the data set. It then determines if the query value is greater than or less than the median value of the entire set. If the value is greater, the upper half of the data set is considered. If the value is less than the median, the lower half the data set is considered. This is repeated until the data can no longer be halved. It is time and calculation intensive, but for the number of points comprising the geofence definitions, is sufficient for this implementation. <br  />
 <br  />
 The geofence task runs any time the sensor suite task outputs new GPS data. It runs the geofence calculations, then outputs them to the navigation task.</p>
<h1><a class="anchor" id="section_motorcontrol"></a>
Motor Control System</h1>
<p >To prevent the motors from bogging down or accelerating on hills, a simple PID control system was developed for the motors. The control systems are contained within a class, allowing simple programming of the motor task with control system objects. While the motors could be operated exclusively by the control system class, the class was designed to take the motor object pointer as an input, allowing the motor tasks to operate the motors directly, if necessary. The control system takes inputs in the form of the encoder velocity and the desired setpoint, then sets the provided motor accordingly. <br  />
 <br  />
 To operate the encoders, an open-source ESP32 encoder class was utilized. The operation of the encoders using this class was placed in a task separate from the motor task to ensure consistent timing between encoder reads, to improve the accuracy of the control system. <br  />
 <br  />
 Each motor task runs only if either the corresponding encoder updates or the navigation task provides a new setpoint. When the task runs, it uses an object of the motorCS class to run the control system and operate the motor. If the control system is not enabled, it runs the motors directly. <br  />
</p>
<h1><a class="anchor" id="section_sensorsuite"></a>
Sensor Suite</h1>
<p >The Sensor Suite task is dependent on both the i2c GPIO expansion bus chip drivers and the external Adafruit VL53L1x. It drives all the safety critical sensors mounted about R8-07. This is the highest priority task and as such runs all of the code linearly. First, if data is available, the GPS string is updated. The NMEA string is decoded via the TinyGPS++ library utilized under the open source license. Next, the primary time of flight sensor is updated, followed by the three ultrasonic sensors mounted on the safety sensor suite. The code for the ultrasonic sensors is blocking, as precise timing of the trigger pin and reading of the echo pin is necessary for accurate readings of the sensors. As such, this is the highest priority task and does not allow interrupts during this process. After data is collected from the safety sensor suite, the task checks each of the three collision sensors ahead of the wheels. To facilitate simpler navigation, the sensor suite task handles some of the processing surrounding this data. The sensor suite task checks the data to see if it meets a minimum threshold, and if collision is imminent based on this check, a Boolean share is toggled to stop the motors. <br  />
</p>
<h1><a class="anchor" id="section_Navigation"></a>
Navigation Algorithm</h1>
<p >The navigation algorithm, in its current form, only implements natural avoidance of the geofence. To accomplish this, it uses the distance and bearing to the geofence, the bearing of the robot, and a pre-defined minimum distance to the fence to turn the robot in a manner inversely proportional to the distance to the geofence and the relative bearing from the robot to the fence. The geometric principle utilized is illustrated in the figure below. <br  />
</p>
<div class="image">
<img src="CurvaturefromFence.png" alt=""/>
<div class="caption">
Geometry of Naturally Avoiding Geofence with a curve</div></div>
<p >Using these computations, the navigation task computes the desired speed and turn rate of the robot, then converts those values into setpoint PWM values to be output to the motor task.</p>
<h1><a class="anchor" id="section_Bluetooth"></a>
Bluetooth Control</h1>
<p >The Bluetooth module was designed to provide an interface between R-8O7 and a smartphone-based application in order to enable the user to remotely control the robot, as well as toggle various functions. The image below illustrates the GUI presented to the user when the application is launched from a smartphone. <br  />
 </p><div class="image">
<img src="BluetoothGUI.png" alt=""/>
<div class="caption">
Bluetooth App GUI for Remote Control</div></div>
<p >The user is able to first connect to R-8O7 via Bluetooth using the ‘Bluetooth Connect’ button. They are presented with a list of paired devices from their phone, one of which is the built in Bluetooth module on the ESP32. The user is then able to use the joystick on the screen to control the throttle and direction of the robot, utilize the three toggles to turn on and off the geofence, navigation, and sensor suite, and bring the robot to a stop in case of emergency. When the user wishes to disconnect from R-8O7, they can do so via the disconnect button. MITAppinventor was used to synthesize the application, and the block code for the program can be seen below. <br  />
</p>
<div class="image">
<img src="MITCode.png" alt=""/>
<div class="caption">
Overview of Block Code Structure for Bluetooth App</div></div>
<p >The block code sets up the Bluetooth interface on the app, controls the function and reset of the joystick, initializes button and switch states to default states upon application launch, and manages the way through which the app sends data to the ESP32 over the Bluetooth serial port. <br  />
 <br  />
 On the C++ side, the module is designed to receive this data from the application over the Bluetooth serial port and process it into useable data by the other tasks. For example, the joystick position is constantly checked and updated to send X and Y axis coordinates over the serial port. By interpreting these X and Y coordinates as throttle and direction amounts, the module then converts these values into pulse width modulation signals that can be read by the motor driver in order to control the motors manually. Furthermore, the button and switch states return either a 1 or 0, allowing for easy toggles on their corresponding tasks. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
